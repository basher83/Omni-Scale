configs:
  ts-serve:
    content: |
      {
        "TCP": {
          "443": { "HTTPS": true },
          "8090": { "HTTPS": true },
          "8100": { "HTTPS": true }
        },
        "Web": {
          "$${TS_CERT_DOMAIN}:443": {
            "Handlers": { "/": { "Proxy": "http://127.0.0.1:8080" } }
          },
          "$${TS_CERT_DOMAIN}:8090": {
            "Handlers": { "/": { "Proxy": "http://127.0.0.1:8090" } }
          },
          "$${TS_CERT_DOMAIN}:8100": {
            "Handlers": { "/": { "Proxy": "http://127.0.0.1:8100" } }
          }
        }
      }

services:
  omni-tailscale:
    image: tailscale/tailscale:latest
    hostname: omni-tailscale
    environment:
      - TS_SERVE_CONFIG=/config/serve.json
      - TS_HOSTNAME=omni
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_ACCEPT_DNS=true
      - TS_USERSPACE=false
      - TS_ENABLE_HEALTH_CHECK=true
    env_file:
      - .env
    configs:
      - source: ts-serve
        target: /config/serve.json
    volumes:
      - ts-state:/var/lib/tailscale
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    devices:
      - /dev/net/tun:/dev/net/tun
    healthcheck:
      test:
        - CMD-SHELL
        - "wget -q --spider http://localhost:9002/healthz && getent hosts controlplane.tailscale.com"
      interval: 5s
      timeout: 5s
      retries: 20
      start_period: 15s

  omni:
    image: ghcr.io/siderolabs/omni:latest
    network_mode: service:omni-tailscale
    depends_on:
      omni-tailscale:
        condition: service_healthy
    cap_add:
      - NET_ADMIN
    volumes:
      - omni-data:/_out
      - ./omni.asc:/omni.asc:ro
      - /dev/net/tun:/dev/net/tun
    command:
      - --sqlite-storage-path=/_out/omni.db
      - --private-key-source=file:///omni.asc
      - --advertised-api-url=https://${OMNI_DOMAIN}/
      - --machine-api-advertised-url=https://${OMNI_DOMAIN}:8090/
      - --advertised-kubernetes-proxy-url=https://${OMNI_DOMAIN}:8100/
      - --siderolink-wireguard-advertised-addr=${OMNI_DOMAIN}:50180
      - --auth-oidc-enabled
      - --auth-oidc-provider-url=${OIDC_ISSUER_URL}
      - --auth-oidc-client-id=${OIDC_CLIENT_ID}
      - --auth-oidc-client-secret=${OIDC_CLIENT_SECRET}
      - --auth-oidc-scopes=openid
      - --auth-oidc-scopes=profile
      - --auth-oidc-scopes=email
      - --initial-users=${OMNI_INITIAL_USER}

  proxmox-provider:
    image: ghcr.io/siderolabs/omni-infra-provider-proxmox:latest
    network_mode: service:omni-tailscale
    depends_on:
      omni-tailscale:
        condition: service_healthy
    volumes:
      - ./config.yaml:/config.yaml:ro
    command:
      - --config-file=/config.yaml
      - --omni-api-endpoint=https://${OMNI_DOMAIN}/
      - --omni-service-account-key=${OMNI_INFRA_PROVIDER_KEY}
      - --id=Proxmox
    restart: unless-stopped

volumes:
  ts-state:
  omni-data:
