services:
  # Tailscale sidecar - provides network connectivity to Omni
  worker-tailscale:
    image: tailscale/tailscale:latest
    container_name: worker-tailscale
    hostname: proxmox-worker-matrix
    environment:
      - TS_AUTHKEY=${TS_AUTHKEY}
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_USERSPACE=false
    volumes:
      - ./tailscale-state:/var/lib/tailscale
    devices:
      - /dev/net/tun:/dev/net/tun
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    healthcheck:
      test: ["CMD", "tailscale", "status"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
    restart: always

  # Proxmox Infrastructure Provider
  # NOTE: Using local-fix tag - upstream has hostname conflict bug
  # See docs/TROUBLESHOOTING.md "Proxmox Provider Hostname Conflict"
  proxmox-provider:
    image: ghcr.io/siderolabs/omni-infra-provider-proxmox:local-fix
    container_name: proxmox-provider
    restart: always
    # Share network namespace with Tailscale sidecar
    network_mode: "service:worker-tailscale"
    depends_on:
      worker-tailscale:
        condition: service_healthy
    volumes:
      - ./config.yaml:/config.yaml:ro
    command:
      - --config-file=/config.yaml
      - --omni-api-endpoint=${OMNI_API_ENDPOINT:-https://omni.spaceships.work/}
      - --omni-service-account-key=${OMNI_SERVICE_ACCOUNT_KEY}
      - --id=${PROVIDER_ID:-matrix-cluster}
