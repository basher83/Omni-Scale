# Production cluster for Matrix (Foxtrot/Golf/Hotel)
# 3 control planes + 3 workers on CEPH storage
# CNI: Disabled for Cilium installation post-bootstrap
#
# Node distribution:
#   Control Planes: Provider-distributed (Omni template limitation)
#   Workers: Pinned to Foxtrot, Golf, and Hotel (one per Proxmox node)

kind: Cluster
name: talos-prod-01
labels:
  environment: production
kubernetes:
  version: v1.35.0
talos:
  version: v1.12.0
patches:
  - name: disable-default-cni
    inline:
      cluster:
        network:
          cni:
            name: none
        proxy:
          disabled: true
---
kind: ControlPlane
machineClass:
  name: matrix-control-plane
  size: 3
systemExtensions:
  - siderolabs/iscsi-tools
  - siderolabs/nfsd
  - siderolabs/util-linux-tools
---
kind: Workers
name: worker-foxtrot
machineClass:
  name: matrix-worker-foxtrot
  size: 1
systemExtensions:
  - siderolabs/iscsi-tools
  - siderolabs/nfsd
  - siderolabs/util-linux-tools
patches:
  - name: worker-labels
    inline:
      machine:
        nodeLabels:
          # node-role.kubernetes.io/worker: ""  # Blocked by NodeRestriction admission
          topology.kubernetes.io/zone: "foxtrot"
  - name: longhorn-storage
    inline:
      machine:
        kubelet:
          extraMounts:
            - destination: /var/lib/longhorn
              type: bind
              source: /var/local/longhorn
              options:
                - bind
                - rshared
                - rw
---
kind: Workers
name: worker-golf
machineClass:
  name: matrix-worker-golf
  size: 1
systemExtensions:
  - siderolabs/iscsi-tools
  - siderolabs/nfsd
  - siderolabs/util-linux-tools
patches:
  - name: worker-labels
    inline:
      machine:
        nodeLabels:
          # node-role.kubernetes.io/worker: ""  # Blocked by NodeRestriction admission
          topology.kubernetes.io/zone: "golf"
  - name: longhorn-storage
    inline:
      machine:
        kubelet:
          extraMounts:
            - destination: /var/lib/longhorn
              type: bind
              source: /var/local/longhorn
              options:
                - bind
                - rshared
                - rw
---
kind: Workers
name: worker-hotel
machineClass:
  name: matrix-worker-hotel
  size: 1
systemExtensions:
  - siderolabs/iscsi-tools
  - siderolabs/nfsd
  - siderolabs/util-linux-tools
patches:
  - name: worker-labels
    inline:
      machine:
        nodeLabels:
          # node-role.kubernetes.io/worker: ""  # Blocked by NodeRestriction admission
          topology.kubernetes.io/zone: "hotel"
  - name: longhorn-storage
    inline:
      machine:
        kubelet:
          extraMounts:
            - destination: /var/lib/longhorn
              type: bind
              source: /var/local/longhorn
              options:
                - bind
                - rshared
                - rw
